name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    name: Build & Release (Arch Linux)
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize pacman
        run: |
          pacman -Sy --noconfirm archlinux-keyring

      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm \
            base-devel \
            cmake \
            git \
            gcc \
            zip \
            tar \
            mingw-w64-crt \
            mingw-w64-headers \
            mingw-w64

      - name: Configure (CMake)
        run: |
          cmake -S . -B build

      - name: Build (Linux)
        run: |
          cmake --build build --parallel

      - name: Build Windows binaries (MinGW)
        run: |
          chmod +x ./build-win.sh
          ./build-win.sh

      - name: Prepare release directory
        run: |
          mkdir -p release

          mv output/nacfetch-amd          release/nacfetch-linux-amd
          mv output/nacfetch-generic      release/nacfetch-linux-generic
          mv output/nacfetch-intel        release/nacfetch-linux-intel

          mv output/nacfetch-amd.exe      release/nacfetch-windows-amd.exe
          mv output/nacfetch-generic.exe  release/nacfetch-windows-generic.exe
          mv output/nacfetch-intel.exe    release/nacfetch-windows-intel.exe

          chmod +x release/nacfetch-linux-*

      - name: Create archives
        run: |
          cd release

          tar -czf nacfetch-linux.tar.gz \
            nacfetch-linux-amd \
            nacfetch-linux-generic \
            nacfetch-linux-intel

          zip nacfetch-linux.zip \
            nacfetch-linux-amd \
            nacfetch-linux-generic \
            nacfetch-linux-intel

          tar -czf nacfetch-windows.tar.gz \
            nacfetch-windows-amd.exe \
            nacfetch-windows-generic.exe \
            nacfetch-windows-intel.exe

          zip nacfetch-windows.zip \
            nacfetch-windows-amd.exe \
            nacfetch-windows-generic.exe \
            nacfetch-windows-intel.exe

      - name: Generate SHA256 checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
